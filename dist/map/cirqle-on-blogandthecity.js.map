{"version":3,"file":"cirqle-on-blogandthecity.js","names":[],"mappings":"","sources":["cirqle-on-blogandthecity.js"],"sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\nvar dataset = require('./modules/dataset');\n\n(function(){\n  // var css_url = \"http://cdn.cirqle.nl/button1/wordpress-buttonv1.0.0-black.css\";\n  var css_url = \"http://cdn.cirqle.nl/button1/cirqle-style-general.css\";\n  var iframe_origin = \"https://cdn.cirqle.nl\"; // domain name of iframecontent.html\n  // var iframe_src_url = iframe_origin+\"/experience-test/iframecontent.html\"; // test\n  var iframe_src_url = iframe_origin+\"/experience2/iframecontent.html\"; //live\n  var jquery_cdn = \"//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js\";\n  var web_component_cdn = \"//cdn.cirqle.nl/polyfills/webcomponents.min.js\";\n  var maxPostCount =  15;\n  var blogName = document.title;\n  var blogDomain = window.location.host;\n  // var apiDomain = \"http://54.73.226.47:9090\"; //test\n  var apiDomain = \"https://api.cirqle.nl:8443\"; //live\n  var segmentIOSwitch = true;\n  var cqjq;\n\n  setSegmentIo();\n\n  if(typeof MutationObserver == 'undefined'){\n    var theNewScript = document.createElement(\"script\");\n    theNewScript.type = \"text/javascript\";\n    theNewScript.src = web_component_cdn;\n    document.getElementsByTagName(\"head\")[0].appendChild(theNewScript);\n  }\n\n  // load jquery if not loaded\n  if(typeof jQuery == \"undefined\"){\n    var theNewScript = document.createElement(\"script\");\n    theNewScript.type = \"text/javascript\";\n    theNewScript.src = jquery_cdn;\n    document.getElementsByTagName(\"head\")[0].appendChild(theNewScript);\n  }\n\n  function loadJqueryIfNotLoaded(cb){\n    // return cb();\n    // jQuery MAY OR MAY NOT be loaded at this stage\n    var waitForLoad = function () {\n      if (typeof jQuery != \"undefined\") {\n        if(jQuery.fn.jquery != \"1.11.1\"){\n          var theNewScript = document.createElement(\"script\");\n          theNewScript.type = \"text/javascript\";\n          theNewScript.src = jquery_cdn;\n          document.getElementsByTagName(\"head\")[0].appendChild(theNewScript);\n          window.setTimeout(waitForLoad, 500);\n        }\n        else{\n          cqjq = jQuery.noConflict();\n          cb();\n        }\n\n      } else {\n        window.setTimeout(waitForLoad, 500);\n      }\n    };\n    window.setTimeout(waitForLoad, 500);\n  }\n\n  function webComponentReady(cb){\n    var waitForLoad = function () {\n      if (typeof MutationObserver == 'undefined') {\n        window.setTimeout(waitForLoad, 500);\n      } else {\n        cb()\n      }\n    };\n    window.setTimeout(waitForLoad, 500);\n  }\n\n  buttonSingleton = (function(){\n    var btns = [];\n    var taggedImgs;\n\n    function saveButton(btn){\n      btns.push(btn);\n    }\n\n    function getAllButtons(){\n      return btns;\n    }\n\n    function getTaggedImg(){\n      return getTaggedImgFromApi();\n    }\n\n    return {\n      getTaggedImg:function(){\n        if(taggedImgs){\n          var defer = jQuery.Deferred();\n          return defer.resolve(taggedImgs)\n        }\n        return getTaggedImg().then(function(data){\n          taggedImgs = data;\n          return taggedImgs;\n        });\n      },\n      saveButton:saveButton,\n      getAllButtons:getAllButtons\n    }\n  })();\n\n  function buttonActivated(){\n    // document.getElementsByTagName(\"body\")[0].dataset.cpButtonActivated = true;\n    dataset(document.getElementsByTagName(\"body\")[0], \"cpButtonActivated\", true);\n  }\n\n  this.cirqle_init = function(b_id, config){\n    var pathName = document.location.pathname;\n\n    cq_config = config || {};\n\n    //overwirte showOnHover = false when on mobile\n    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || /Mobile/i.test(navigator.userAgent)) {\n      cq_config = {showOnHover:false};\n    }\n\n    blog_id = b_id;\n    cirqle_getpost_by_url = apiDomain + \"/api/1/blogs/\"+blog_id+\"/photos?tagged=true\";\n    cirqle_getPostid_by_blogid_url = apiDomain + \"/api/1/posts/blog/\"+blog_id;\n    cirqle_getpost_by_postid_url = apiDomain + \"/api/1/posts/{post_id}/blog/\"+blog_id+\"/photos?tagged=true\";\n\n    loadJqueryIfNotLoaded(function(){\n\n      // jQuery(function() {\n      // your page initialization code here\n      // the DOM will be available here\n\n      // set up cirqle button environment. eg load css file, segment io setting\n      if(cq_config.customCss && typeof cq_config.customCss == \"string\" && cq_config.customCss.indexOf(\"cdn.cirqle.nl\") > -1){\n        css_url = cq_config.customCss;\n      }\n      setCirqleCss(document, css_url);\n\n      // segment IO identify user, anonymous in this case\n      window.onload = function(){\n        identity();\n      }\n\n      // send tracking of blog view with cirqle button embedded\n      track(\"blogView\", {\n        blogId: blog_id\n      });\n\n      // findPostImage\n      embedButtonOnLoad(document);\n\n      var body = document.getElementsByTagName('body')[0]\n      var id;\n\n      webComponentReady(function(){\n        // create an observer instance\n        var observer = new MutationObserver(function(mutations) {\n          var mutated = false;\n\n          for(var i=0; i < mutations.length; i++) {\n            var mutation = mutations[i];\n            var addedNodes = mutation.addedNodes;\n            var target = mutation.target;\n            var type = mutation.type;\n\n            for(var j=0; j < addedNodes.length; j++){\n              if(!addedNodes[j].querySelectorAll){continue;}\n\n                var img = addedNodes[j].querySelectorAll('img');\n                if(img.length > 0){\n                  mutated = true;\n                  break;\n                }\n              }\n\n              var img = target.querySelectorAll('img');\n              if(img.length > 0){\n                mutated = true;\n              }\n\n              if(mutated){\n                break;\n              }\n            }\n\n            if(mutated){\n              clearTimeout(id);\n              // jQuery('.cirqle-outer-button').hide();\n              // jQuery('.cirqle-outer-button').fadeOut();\n              id = setTimeout(doneChanging, 1000);\n            }\n          });\n\n          // configuration of the observer:\n          var config = { attributes: true, childList: true, characterData: true, subtree: true };\n\n          // pass in the target node, as well as the observer options\n          observer.observe(body, config);\n\n        });\n\n        function doneChanging(){\n          repositionButton();\n        }\n\n        // Handle post that show up after on load. eg. lazy loading\n        document.getElementsByTagName(\"body\")[0].addEventListener(\"DOMNodeInserted\", function(e) {\n          var inserted = e.target;\n          if(!inserted.querySelectorAll){return;}\n            var image = inserted.querySelectorAll('img');\n            var iframe = inserted.querySelectorAll(\"iframe[src*='\"+document.domain+\"/post']\");\n\n            if(image.length > 0 || iframe.length > 0){\n              //Handle post that show up on load\n              embedButtonOnLoad(inserted);\n            }\n          });\n\n\n          function iframelistener(event){\n            if ( event.origin !== iframe_origin ){\n              return;\n            }\n\n            var message = event.data;\n            if(message instanceof Object){\n              message = JSON.parse(message);\n              track(\"productView\", {\n                blogId: blog_id,\n                postId: message.postId,\n                productId: message.productId\n              });\n            }\n          }\n\n          if (window.addEventListener){\n            attachHandler(window, \"message\", iframelistener);\n          } else {\n            attachHandler(window, \"onmessage\", iframelistener);\n          }\n\n          var id;\n          cqjq(window).resize(function() {\n            // touch screen trigger resize, only fadeout when not device\n            clearTimeout(id);\n            id = setTimeout(doneResizing, 500);\n          });\n\n          function doneResizing(){\n            repositionButton(); // some theme doesn't fire mutation event on viewport change, we have to manually forse reposition upon resizing\n          }\n\n          // });\n\n        });\n      }\n\n  function clearButton(){\n    buttons.forEach(function(btnObj){\n      if(!isHidden(btnObj.img)){\n        // jQuery(btnObj.btn).fadeIn();\n      }\n      else{\n        // jQuery(btnObj.btn).fadeOut();\n      }\n    });\n  }\n\n  function repositionButton(){\n    var buttons = buttonSingleton.getAllButtons();\n    if(buttons.length == 0){return;}\n\n      for(var i=0; i < buttons.length; i++){\n        btnObj = buttons[i];\n        if(btnObj.btn.style.position == \"relative\"){\n          continue; // exclude button posistioned by relative\n        }\n        else if(isHidden(btnObj.img)){\n          cqjq(btnObj.btn).hide();\n          continue;\n        }\n        else{\n          // if(isMoved(btnObj.img) || isMoved(btnObj.btn)){\n          positionButtonAbsolute(btnObj.img, btnObj.btn);\n          // }\n        }\n      }\n    }\n\n  function isMoved(el){\n    var offset = getNodePosition(el);\n    return (Math.abs(offset[0] - el.absoluteTop) > 0) || (Math.abs(offset[1] - el.absoluteLeft) > 0) || (Math.abs(el.height - el.previousHeight) > 0) || (Math.abs(el.width - el.previousWidth) > 0);\n  }\n\n  function setSegmentIo(){\n    if(segmentIOSwitch){\n      try{\n        if(!window.analytics){\n          window.analytics=window.analytics||[],window.analytics.methods=[\"identify\",\"group\",\"track\",\"page\",\"pageview\",\"alias\",\"ready\",\"on\",\"once\",\"off\",\"trackLink\",\"trackForm\",\"trackClick\",\"trackSubmit\"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var key=window.analytics.methods[i];window.analytics[key]=window.analytics.factory(key)}window.analytics.load=function(t){if(!document.getElementById(\"analytics-js\")){var a=document.createElement(\"script\");a.type=\"text/javascript\",a.id=\"analytics-js\",a.async=!0,a.src=(\"https:\"===document.location.protocol?\"https://\":\"http://\")+\"cdn.segment.io/analytics.js/v1/\"+t+\"/analytics.min.js\";var n=document.getElementsByTagName(\"script\")[0];n.parentNode.insertBefore(a,n)}},window.analytics.SNIPPET_VERSION=\"2.0.9\",\n          window.analytics.load(\"nfllvg24aq\");\n        }\n\n      }catch(e){}\n      // window.analytics.page();\n    }\n  }\n\n  function identity(){\n    if(segmentIOSwitch){\n      analytics.identify({\n        integrations: {\n          'All': false,\n          'Webhooks': true\n        }\n      }, function(){\n      });\n    }\n  }\n\n  function track(action, traits){\n    if(segmentIOSwitch){\n      analytics.track(action, traits, {\n        integrations: {\n          'All': false,\n          'Webhooks': true\n        }\n      }, function(){\n      });\n    }\n  }\n\n  function setCirqleCss(scope, css){\n    var s = scope.createElement('link');\n    s.rel = \"stylesheet\"\n    s.type = \"text/css\";\n    s.href = css;\n    s.id = \"cirqlecss_\"+blog_id;\n    scope.head.appendChild(s);\n  }\n\n  function getTaggedImgFromApi(){\n    return cqjq.getJSON(cirqle_getpost_by_url);\n  }\n\n  function embedButtonOnLoad(content){\n    try{\n      buttonActivated();\n      // getPostImageFromAPI(content);\n      var imgIdentifier = \"media.tumblr.com\"; // speed up img look up\n      findPostImage(content, imgIdentifier);\n\n    }catch(e){\n    }\n  }\n\n  /*imgIdentifyMethods.page = true*/\n  function findPostImage(scope, post_img_identifier){\n    var domain  = document.domain;\n    var postImagesNodeAndURL = [];\n    var selector = post_img_identifier ? \"img[src*='\"+post_img_identifier+\"']\" : \"img\";\n\n    var postImagewidth = 131;\n    var postImageheight = 32;\n    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){\n      var postImagewidth = 66;\n      var postImageheight = 32;\n    }\n\n    buttonSingleton.getTaggedImg().then(function(imgUrls){\n        for(var i = imgUrls.length-1; i >=0; i--){\n            var selector = \"img[src*='\"+removeUrlParam(imgUrls[i])+\"'],img[data-img*='\"+removeUrlParam(imgUrls[i])+\"']\";\n            var imgElms = scope.querySelectorAll(selector);\n\n        for(var j = imgElms.length-1; j >=0; j--){\n          var imgElm = imgElms[j];\n          if(imgElm && !dataset(imgElm, \"cqUuid\")){\n            (function(imgElm, i){\n              if(imgElm.height == 0 || imgElm.width == 0){\n                cqjq(\"<img/>\")\n                .load(function() {\n                  getPostImageInfo(imgUrls[i]).then(function(data){\n                    if(data.length > 0){\n                      embeddShopButton(imgElm, data[0]);\n                    }\n                  });\n                })\n                .error(function() {})\n                .attr(\"src\", imgElm.src);\n              }\n              else{\n                getPostImageInfo(imgUrls[i]).then(function(data){\n                  if(data.length > 0){\n                    embeddShopButton(imgElm, data[0]);\n                  }\n                });\n              }\n\n            })(imgElm, i);\n          }\n        }\n\n      }\n    });\n\n    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || /Mobile/i.test(navigator.userAgent)) {\n      // disable iframe button if on mobile\n      return;\n    }\n\n    // // iframe\n    var iframe = scope.querySelectorAll(\"iframe[src*='\"+domain+\"/post']\") || [];\n\n    // for every iframe found\n    for(var i = 0; i < iframe.length; i++){\n        (function(i){\n            //wait for each iframe to be loaded before accessing its element\n            cqjq(iframe[i]).load(function(){\n                // set iframe css\n                setCirqleCss(iframeRef(this), css_url);\n                (function(ifrmScope){\n                    buttonSingleton.getTaggedImg().then(function(imgUrls){\n                        for(var i = imgUrls.length-1; i >=0; i--){\n                            var selector = \"img[src*='\"+removeUrlParam(imgUrls[i])+\"']\";\n                            var imgElm = ifrmScope.querySelector(selector);\n\n                if(imgElm && !dataset(imgElm, \"cqUuid\")){\n                  (function(imgElm, ifrmScope){\n                    if(imgElm.height == 0 || imgElm.width == 0){\n                      cqjq(\"<img/>\")\n                      .load(function() {\n                        getPostImageInfo(imgUrls[i]).then(function(data){\n                          if(data.length > 0){\n                            embeddShopButton(imgElm, data[0], ifrmScope);\n                          }\n                        });\n                      })\n                      .error(function() {})\n                      .attr(\"src\", imgElm.src);\n                    }\n                    else{\n                      getPostImageInfo(imgUrls[i]).then(function(data){\n                        if(data.length > 0){\n                          embeddShopButton(imgElm, data[0], ifrmScope);\n                        }\n                      });\n                    }\n                  })(imgElm, ifrmScope);\n                }\n              }\n            });\n          })(iframeRef(this));\n        });\n\n      })(i);\n    }\n  }\n\n  function getPostImageInfo(imgurl){\n    var url = apiDomain + \"/api/1/posts/products?url=\"+imgurl+\"&blogId=\"+blog_id;\n    return cqjq.getJSON(url);\n  }\n  /*imgIdentifyMethods.page = true*/\n\n  function createButton(imgNode, uuid){\n    var button = document.createElement('div');\n    button.className = \"cirqle-btn\";\n    // button.dataset.uuid = uuid;\n    // imgNode.dataset.cqUuid = uuid;\n    dataset(button, \"uuid\", uuid);\n    dataset(imgNode, \"cqUuid\", uuid);\n\n    var icon = document.createElement('div');\n    icon.className = \"cirqle-btn-icon\";\n    icon.innerHTML = '<svg height=\"32\" id=\"shopping-cart\" viewBox=\"0 0 32 32\" width=\"32\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\" M0 4 L5 4 L6 8 L30 8 L28 22 L6 22 L3.5 6 L0 6z M10 24 A3 3 0 0 0 10 30 A3 3 0 0 0 10 24 M24 24 A3 3 0 0 0 24 30 A3 3 0 0 0 24 24 \"></path></svg>';\n\n    var text = document.createElement('div');\n    text.className = \"cirqle-btn-copy\";\n    text.innerHTML = \"Shop this post\";\n\n    button.appendChild(icon);\n    button.appendChild(text);\n\n    return button;\n  }\n\n  function embedButtonAbsolute(imgNode, uuid, ifrmScope){\n    var button = createButton(imgNode, uuid)\n\n    var outerButton = document.createElement('div');\n\n    outerButton.appendChild(button);\n    if(ifrmScope){\n      ifrmScope.getElementsByTagName(\"body\")[0].appendChild(outerButton);\n      outerButton = positionButtonRelative(imgNode, outerButton, button);\n    }else{\n      document.getElementsByTagName(\"body\")[0].appendChild(outerButton);\n      outerButton = positionButtonAbsolute(imgNode, outerButton);\n    }\n    // outerButton.dataset.uuid = uuid;\n    dataset(outerButton, \"uuid\", uuid);\n\n    return outerButton;\n  }\n\n  function positionButtonRelative(imgNode, btnNode, button){\n    btnNode.className = \"cirqle-outer-button\";\n    cqjq(btnNode).hide(); // must hide it in order to get the computed dimension\n\n    var offsetFromBottomRight = 15;\n    var btnHeight = parseInt(cqjq(btnNode).css('height'));\n    var btnWidth = parseInt(cqjq(btnNode).css('width'));\n    cqjq(btnNode).show();\n\n    var buttonTop = offsetFromBottomRight + btnHeight; // button height 32px/32px\n    var buttonRight = offsetFromBottomRight; // button width 131px/66px\n\n    btnNode.style.zIndex = \"102\";\n    btnNode.style.position = \"relative\";\n    btnNode.style.height = \"0px\";\n    imgNode.parentNode.appendChild(btnNode); //append outer button\n\n    button.style.position = \"absolute\";\n    button.style.top = \"-\"+buttonTop+\"px\";\n    button.style.right = buttonRight+\"px\";\n\n    return btnNode;\n  }\n\n  function positionButtonAbsolute(imgNode, btnNode){\n    btnNode.className = \"cirqle-outer-button\";\n    cqjq(btnNode).hide(); // must hide it in order to get the computed dimension\n\n    var offsetFromBottomRight = 15;\n    var imgPos = getNodePosition(imgNode);\n    var btnHeight = parseInt(cqjq(btnNode).css('height'));\n    var btnWidth = parseInt(cqjq(btnNode).css('width'));\n    cqjq(btnNode).show();\n\n    // assign previous button position and dimension\n    // btnNode.absoluteTop = btnNode.style.top;\n    // btnNode.absoluteLeft = btnNode.style.left;\n    // btnNode.previousHeight = btnHeight;\n    // btnNode.previousWidth = btnWidth;\n\n    //ipad and tablet shows desktop button\n    var buttonTop = imgPos[0] + imgNode.height - offsetFromBottomRight - btnHeight; // button height 32px/32px\n    var buttonLeft = imgPos[1] + imgNode.width - offsetFromBottomRight - btnWidth; // button width 131px/66px\n\n    console.log(imgPos);\n    console.log(imgNode.height, imgNode.width);\n    console.log(btnHeight, btnWidth);\n    // console.log(highestZIndex(0, btnNode)+1);\n    var current = parseInt(cqjq(btnNode).css(\"z-index\"), 10);\n    if(isNaN(current)) btnNode.style.zIndex = highestZIndex(0, btnNode)+1;\n\n    btnNode.className = \"cirqle-outer-button\";\n    btnNode.style.position = \"absolute\";\n    btnNode.style.top = buttonTop+\"px\";\n    btnNode.style.left = buttonLeft+\"px\";\n\n    return btnNode;\n  }\n\n  function embeddShopButton(imgNode, imgObj, ifrmScope){\n    if(dataset(imgNode, \"postId\")){\n      // shop button has been embedded\n      return;\n    }\n    // imgNode.dataset.postId = imgObj.postId;\n    dataset(imgNode, \"postId\", imgObj.postId);\n\n    var el = imgNode;\n    var uuid = guid();\n\n    var imgHover = el;\n\n    var button = embedButtonAbsolute(imgNode, uuid, ifrmScope);\n\n    if(parseInt(cqjq(button).css('width')) > imgNode.width){\n        try {\n            button.parentNode.removeChild(button);\n        }\n        catch(err) {}\n        return;\n    }\n\n    var trackTraits = {\n      blogId: blog_id,\n      postId: imgObj.postId,\n      imageUrl: imgObj.url\n    };\n\n    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {\n      // some code..\n    }\n    else{\n      // button on hidden\n      if(cq_config.showOnHover && cq_config.showOnHover === true){button.style.visibility = \"hidden\";}\n\n        (function(){\n          if(cq_config.showOnHover && cq_config.showOnHover === true){\n            attachHandler(button, \"mouseenter\", function(e) {\n              button.style.visibility = \"visible\";\n            });\n\n            attachHandler(button, \"mouseleave\", function(e) {\n              button.style.visibility = \"hidden\";\n            });\n          }\n\n          var timer = new Timer();\n          attachHandler(imgHover, \"mouseenter\", function(e) {\n            timer.start();\n            if(cq_config.showOnHover && cq_config.showOnHover === true){button.style.visibility = \"visible\";}\n            });\n\n            attachHandler(imgHover, \"mouseleave\", function(e) {\n              timer.end(function(duration){\n                var traits = cqjq.extend({}, trackTraits, {duration: duration});\n                track(\"postImageHover\", traits);\n              });\n              if(cq_config.showOnHover && cq_config.showOnHover === true){button.style.visibility = \"hidden\";}\n              });\n\n            })()\n          }\n\n          attachHandler(button, \"click\", function(e) {\n            e.stopPropagation();\n\n            var timer = new Timer();\n\n        // append iframe window here\n        showWindow(imgObj, timer, trackTraits);\n        toogleParentScrollY();\n        //show positioned iframe\n        tooglePurchaseDialog(timer, trackTraits);\n\n            function closeiframelistener(event){\n              if ( event.origin !== iframe_origin ){\n                return;\n              }\n\n              var message = event.data;\n\n              if(message == \"cqCloseShopWindow\"){\n                //close positioned iframe\n                tooglePurchaseDialog(timer, trackTraits);\n                toogleParentScrollY();\n              }\n            }\n\n            if (window.addEventListener){\n              attachHandler(window, \"message\", closeiframelistener);\n            } else {\n              attachHandler(window, \"onmessage\", closeiframelistener);\n            }\n\n            // if( /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {\n            //     showPurchaseDialogMobile(data);\n            // }\n            // else{\n            //     appendPurchaseDialog(data);\n            // }\n            // tooglePurchaseDialog();\n            // alert(\"buy button clicked\")\n\n            // track clicked rate through segment IO\n            track(\"shopbuttonClicked\", trackTraits);\n\n            // stop event bubbling to prevent fire of outer link\n            if (!e) var e = window.event;\n            e.cancelBubble = true;\n            e.preventDefault();\n            if (e.stopPropagation) e.stopPropagation();\n\n            return false;\n\n          }, true); // set true for even capturing instead of bubbling\n\n          // save button for repositioning when viewport changed\n          var imgPos = getNodePosition(el);\n          el.absoluteTop = imgPos[0];\n          el.absoluteLeft = imgPos[1];\n          el.previousHeight = el.height;\n          el.previousWidth = el.width;\n          buttonSingleton.saveButton({img:el, btn:button, uuid:uuid});\n\n          if(isHidden(el)){\n            cqjq(button).hide();\n          }\n\n        }\n\nfunction showWindow(img, timer, trackTraits){\n    // <iframe class=iframe-hidden src=index.html style=\"border:0; width:100%; height:100%; position:fixed; top:0; z-index:99999\"></iframe>\n    // delete previous content if any\n    try {\n      var prevContent = document.getElementById(\"cq-shopwindow\");\n      prevContent.parentNode.removeChild(prevContent);\n    }\n    catch(err) {}\n\n    var iframe = document.createElement('iframe');\n    iframe.src = iframe_src_url+'?imageurl='+encodeURIComponent(img.url)+\"&bloggerid=\"+img.bloggerId+\"&blogid=\"+blog_id+\"&postid=\"+img.postId+\"&blogname=\"+blogName+\"&blogdomain=\"+blogDomain+\"&posturl=\"+img.postUrl;\n    iframe.style.border = \"0\";\n    iframe.style.width = \"100%\";\n    iframe.style.height = \"100%\";\n\n    var iframeDiv = document.createElement('div');\n    iframeDiv.style.visibility = \"hidden\";\n    // iframeDiv.setAttribute('style', '-webkit-overflow-scrolling: touch;');\n    if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {\n      iframeDiv.setAttribute('style', '-webkit-overflow-scrolling: touch !important; overflow-y: scroll !important;');\n    }\n\n    if( /iPhone|iPad|iPod/i.test(navigator.userAgent) ) {\n      // only safari mobile\n      //solution http://stackoverflow.com/questions/23083462/how-to-get-an-iframe-to-be-responsive-in-ios-safari\n      iframeDiv.style.height = \"10px\";\n      iframeDiv.style.minHeight = \"100%\";\n      iframe.scrolling = \"no\";\n    }else{\n      iframeDiv.style.height = \"100%\";\n    }\n\n    iframeDiv.style.width = \"100%\";\n    iframeDiv.style.position = \"fixed\";\n    iframeDiv.style.top = \"0\";\n    iframeDiv.style.left = \"0\";\n    // iframeDiv.style.zIndex = parseInt(cqjq(button).css(\"z-index\"), 10)+1;\n    iframeDiv.style.overflow = \"auto\";\n    iframeDiv.id = \"cq-shopwindow\";\n    iframeDiv.appendChild(iframe);\n\n    document.getElementsByTagName(\"body\")[0].appendChild(iframeDiv);\n    iframeDiv.style.zIndex = highestZIndex(0, iframeDiv)+2; // button is +1\n\n  }\n\n  function toogleParentScrollY(){\n    var prevContent = document.getElementById(\"cq-noscrolly-css\");\n\n    if(prevContent){\n      prevContent.parentNode.removeChild(prevContent);\n      repositionButton();\n    }\n    else{\n      var s = document.createElement('style');\n      s.type = \"text/css\";\n      s.id = \"cq-noscrolly-css\"\n      document.head.appendChild(s);\n\n      var styles = \"body {overflow:hidden !important;}\";\n\n      try{s.innerHTML = styles;}\n      //IE fix\n      catch(error){s.styleSheet.cssText = styles;}\n    }\n  }\n\n  function tooglePurchaseDialog(timer, trackTraits){\n\n    var shopwindow = document.getElementById(\"cq-shopwindow\");\n\n    if(shopwindow && shopwindow.style.visibility == \"visible\"){\n      // instead of hiding the shop window, delete it\n      // shopwindow.style.visibility = \"hidden\";\n      try {\n        var prevContent = document.getElementById(\"cq-shopwindow\");\n        prevContent.parentNode.removeChild(prevContent);\n      }\n      catch(err) {}\n\n\n      if(timer instanceof Timer){\n        timer.end(function(duration){\n          var traits = cqjq.extend({}, trackTraits, {duration: duration});\n          track(\"shopwindowOpen\", traits);\n        });\n      }\n    }\n    else{\n      shopwindow.style.visibility = \"visible\";\n      timer.start();\n    }\n\n  }\n\n  // small timer object\n  function Timer(){\n    this.start = function(){\n      this.startTime = new Date();\n    };\n    this.end = function(cb){\n      if(!(this.startTime && this.startTime instanceof Date)){cb(false)}\n\n      var end = new Date();\n      cb(end.getTime() - this.startTime.getTime());\n    };\n  }\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n  // utilities function\n  function isHidden(el) {\n    try{\n      var p = el;\n      while(p){\n        var style = window.getComputedStyle(p);\n        if(style != null && (style.display === 'none' || style.visibility == 'hidden' || style.opacity == 0)){\n          return true;\n        }\n        p = p.parentNode;\n      }\n      return false;\n\n    }catch(e){\n      return false;\n    }\n\n    // var style = window.getComputedStyle(el);\n    // return (style.display === 'none' || style.visibility == 'hidden')\n  }\n\nfunction highestZIndex(defaultIndex, btn){\n    var highest = defaultIndex;\n    if(!highest){highest = 8;} // becasue blogger image slider is 10\n\n    // cqjq(\"*\").each(function() {\n    //     var current = parseInt(cqjq(this).css(\"z-index\"), 10);\n    //     var position = cqjq(this).css(\"position\");\n    //     var isVisible = cqjq(this).is(\":visible\");\n    //     var className = cqjq(this).attr(\"class\");\n    //     if(current && current > highest && !isNaN(current) && position && position != \"static\" && isVisible && className != \"cirqle-outer-button\"){\n    //         var intersect = findIntersectors(this, btn);\n    //         if(intersect.length > 0) highest = current;\n    //     }\n    // });\n\n    highest = Math.max.apply(null,cqjq.map(cqjq('body > *'), function(e,n){\n        var current = parseInt(cqjq(e).css(\"z-index\"), 10);\n        var position = cqjq(e).css(\"position\");\n        var isVisible = cqjq(e).is(\":visible\");\n        var className = cqjq(e).attr(\"class\");\n        var id = cqjq(e).attr(\"id\");\n        if(current && !isNaN(current) && position && position != \"static\" && isVisible && className != \"cirqle-outer-button\" && id != \"cq-shopwindow\"){\n            var intersect = findIntersectors(e, btn);\n            if(intersect.length > 0)\n                return current;\n            else{\n                return defaultIndex;\n            }\n        }else{\n            return defaultIndex;\n        }\n    }));\n\n    return highest\n}\n\nfunction findIntersectors(targetSelector, intersectorsSelector) {\n    var intersectors = [];\n\n    var $target = cqjq(targetSelector);\n    var tAxis = $target.offset();\n    var t_x = [tAxis.left, tAxis.left + $target.outerWidth()];\n    var t_y = [tAxis.top, tAxis.top + $target.outerHeight()];\n\n    cqjq(intersectorsSelector).each(function() {\n          var $this = cqjq(this);\n          var thisPos = $this.offset();\n          var i_x = [thisPos.left, thisPos.left + $this.outerWidth()]\n          var i_y = [thisPos.top, thisPos.top + $this.outerHeight()];\n\n          if ( t_x[0] < i_x[1] && t_x[1] > i_x[0] &&\n               t_y[0] < i_y[1] && t_y[1] > i_y[0]) {\n              intersectors.push($this);\n          }\n\n    });\n    return intersectors;\n}\n\nfunction getNodePosition(node) {\n    var offset = cqjq(node).offset();\n    var top = parseInt(offset.top);\n    var left = parseInt(offset.left);\n    if(cqjq('body').css('position') == 'relative'){\n      var body = cqjq('body').offset();\n      left -= parseInt(body.left);\n      top -= parseInt(body.top);\n    }\n\n    return [top, left];\n  }\n\n  function nodePosition(node){\n    var top = left = 0;\n    while (node) {\n      if (node.tagName) {\n        var offset = cqjq(node).offset();\n        top = top + offset.top;\n        left = left + offset.left;\n      }\n      node = node.parentNode;\n    }\n\n    return [top, left];\n  }\n\n  function arr_diff(a1, a2){\n    var a=[], diff=[];\n\n    for(var i=0;i<a1.length;i++)\n      a[a1[i]]=true;\n\n    for(var i=0;i<a2.length;i++)\n      if(a[a2[i]]) delete a[a2[i]];\n      else a[a2[i]]=true;\n\n    for(var k in a)\n      diff.push(k);\n\n    return diff;\n  }\n\n  function getTumblrImageId(imageURL){\n    // media.tumblr.com\n    if(imageURL.indexOf(\"media.tumblr.com\") > -1){\n      imageURL  = imageURL.substring(0, imageURL.lastIndexOf(\"/\"));\n      return imageURL.substring(imageURL.lastIndexOf(\"/\")+1);\n    }\n    else{\n      return removeUrlParam(imageURL);\n    }\n  }\n\n  function attachHandler(element, event, handler, bubble) {\n    if(!bubble){\n      bubble = false;\n    }\n\n    if(element.addEventListener){\n      element.addEventListener(event, handler, bubble);\n    } else if(element.attachEvent){\n      element.attachEvent(event, handler, bubble);\n    }\n  }\n\n  function storeData(data, id){\n    localStorage.setItem(id, JSON.stringify(data) );\n  }\n\n  function getData(id){\n    return (localStorage.getItem(id) === null) ? null : JSON.parse(localStorage.getItem(id));\n  }\n\n  function iframeRef( frameRef ) {\n    return frameRef.contentWindow ? frameRef.contentWindow.document : frameRef.contentDocument;\n  }\n\n  function isElement(o){\n    return (\n      typeof HTMLElement === \"object\" ? o instanceof HTMLElement : //DOM2\n      o && typeof o === \"object\" && o !== null && o.nodeType === 1 && typeof o.nodeName===\"string\"\n    );\n  }\n\n  function getScrollPositionXY(){\n    var xscroll = (document.all ? document.scrollLeft : window.pageXOffset);\n    var yscroll = (document.all ? document.scrollTop : window.pageYOffset);\n\n    return [xscroll, yscroll];\n  }\n\n  function isElementInViewport(el){\n\n    //special bonus for those using cqjq\n    if (el instanceof cqjq) {\n      el = el[0];\n    }\n\n    var rect = el.getBoundingClientRect();\n\n    return (\n      rect.top >= 0 &&\n      rect.left >= 0 &&\n      rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) && /*or $(window).height() */\n      rect.right <= (window.innerWidth || document.documentElement.clientWidth) /*or $(window).width() */\n    );\n  }\n\n  var guid = (function() {\n    function s4() {\n      return Math.floor((1 + Math.random()) * 0x10000)\n      .toString(16)\n      .substring(1);\n    }\n    return function() {\n      return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();\n    };\n  })();\n\n  function removeUrlParam(url){\n    return url.split(\"?\")[0].split(\"#\")[0];\n  }\n\n\n  var self = this;\n  _cq = _cq || [];\n  while(_cq.length) {\n    var params = _cq.shift();   // remove the first item from the queue\n    var method = params.shift();    // remove the method from the first item\n    self[method].apply(self, params);\n  }\n\n  _cq.push = function(params) {\n    var method = params.shift();    // remove the method from the first item\n\n    self[method].apply(self, params);\n  }\n})();\n\n},{\"./modules/dataset\":2}],2:[function(require,module,exports){\nmodule.exports=dataset;\n\n/*global document*/\n\n\n// replace namesLikeThis with names-like-this\nfunction toDashed(name) {\n  return name.replace(/([A-Z])/g, function(u) {\n    return \"-\" + u.toLowerCase();\n  });\n}\n\nvar fn;\n\nif (document.head && document.head.dataset) {\n  fn = {\n    set: function(node, attr, value) {\n      node.dataset[attr] = value;\n    },\n    get: function(node, attr) {\n      return node.dataset[attr];\n    },\n    del: function (node, attr) {\n      delete node.dataset[attr];\n    }\n  };\n} else {\n  fn = {\n    set: function(node, attr, value) {\n      node.setAttribute('data-' + toDashed(attr), value);\n    },\n    get: function(node, attr) {\n      return node.getAttribute('data-' + toDashed(attr));\n    },\n    del: function (node, attr) {\n      node.removeAttribute('data-' + toDashed(attr));\n    }\n  };\n}\n\nfunction dataset(node, attr, value) {\n  var self = {\n    set: set,\n    get: get,\n    del: del\n  };\n\n  function set(attr, value) {\n    fn.set(node, attr, value);\n    return self;\n  }\n\n  function del(attr) {\n    fn.del(node, attr);\n    return self;\n  }\n\n  function get(attr) {\n    return fn.get(node, attr);\n  }\n\n  if(!node.nodeType){\n    return null;\n  }\n\n  if (arguments.length === 3) {\n    return set(attr, value);\n  }\n  if (arguments.length == 2) {\n    return get(attr);\n  }\n\n  return self;\n}\n\n},{}]},{},[1]);\n"],"sourceRoot":"/source/"}