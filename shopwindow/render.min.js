function updatePrimaryProduct(e){var t='<div class="product"><a href="{{productUrl}}" target="_blank"><div class="productImage productImageHeight" style="background-image: url({{imageLargeUrl}});"></div></a></div>';var n='<div class="secondBox secondBoxFontSize"><span class="productName productNameFontSize">{{name}}</span><span class="productPrice productPriceFontSize">{{#checkCurrency}} {{currency}} {{/checkCurrency}} {{#checkPrice}} {{price}} {{/checkPrice}}</span></div><div class="divider"></div><div class="secondBox"><a href="{{productUrl}}" id="buybtn" target="_blank"><span class="secondBoxBuyButton">{{#shortenTitle}} {{brand}} {{/shortenTitle}}</span></a></div><div class="divider"></div><div class="secondBox secondBoxFontSize description"><span class="productInformation productInformationFontSize">Product information</span><div class="secondBoxOuterScroll"><div class="secondBoxInnerScroll"><span class="productDesc productDescFontSize">{{description}}</span></div></div></div>';var r=e;r.checkCurrency=function(){return function(e,t){return this.currency||"$"}};r.checkPrice=function(){return function(e,t){return this.price||""}};r.shortenTitle=function(){return function(e,t){var n=this.brand?"BUY AT "+String(this.brand).toUpperCase():"BUY";return t(n)}};var i=Mustache.render(t,r);var s=Mustache.render(n,r);$("#cq-dialog-purchase-content #part1").html(i);$("#cq-dialog-purchase-content #part2").html(s);trackProductView(e.id,postId);$("div.productImage").css({visibility:"hidden"});var o=$("div.productImage").css("background-image");var u=o.match(/\((.*?)\)/)[1].replace(/('|")/g,"");var a=new Image;attachHandler(a,"load",function(){$("div.productImage").css({opacity:0,visibility:"visible"}).animate({opacity:1},1e3)});a.src=u;if(a.complete){$("div.productImage").css({opacity:0,visibility:"visible"}).animate({opacity:1},1e3)}}function shortenString(e,t,n){n=n||"...";t=t||e.length;if(t>n.length){t=t-n.length}else{return n}return e.length>t?e.substring(0,t)+n:e}function generateSlider(e){function s(e){e=$(e);var n=e.css("background-image");var r=n.match(/\((.*?)\)/)[1].replace(/('|")/g,"");var i=new Image;attachHandler(i,"load",function(){e.css({opacity:0,visibility:"visible"}).animate({opacity:1},500);if(t.length>0){s(t.shift())}});i.src=r;if(i.complete){e.css({opacity:0,visibility:"visible"}).animate({opacity:1},500)}}var t=new Array;for(var n=0;n<e.length;n++){var r=e[n];var i=document.createElement("div");i.style.backgroundImage="url("+r.imageSmallUrl+")";i.className="sliderImage sliderImageSize";document.getElementById("productSlider").appendChild(i);t.push(i);registerLinkClickedUpdateContentEvent(i,r)}s(t.shift())}function attachHandler(e,t,n){if(e.addEventListener){e.addEventListener(t,n,false)}else if(e.attachEvent){e.attachEvent(t,n,false)}}function getUrlParameters(e,t,n){var r=t.length?t:window.location.search,i=r.split("?")[1].split("&"),s=true;for(var o=0;o<i.length;o++){parr=i[o].split("=");if(parr[0]==e){return n?decodeURIComponent(parr[1]):parr[1];s=true}else{s=false}}if(!s)return false}function getProducts(e,t){var n=cq_getproduct_url+"?url="+e+"&maxResults=20"+"&postId="+postId;$.ajax({url:n,dataType:"json",success:function(e){t(e)},error:function(e,n,r){console.log(n);t([])}})}function generateHash(e,t,n,r){var i="http://54.73.226.47:8080/tracking/generate?postId="+r+"&imageUrl="+n+"&blogId="+t+"&bloggerId="+e;return $.getJSON(i)}function sendBuyTrack(e){var t="http://54.217.202.215:8080/api/1/blogs/"+e.blogId+"/"+encodeURIComponent(e.imageUrl)+"/clicked?hash="+e.hash;return $.getJSON(t)}function buyTrack(e,t,n,r){generateHash(e,t,n,r).then(function(e){var r={hash:e.code,blogId:t,imageUrl:n};sendBuyTrack(r).done(function(){console.log("buy action tracked")})})}var cq_getproduct_url="http://54.217.202.215:8080/api/1/posts/products/full";var registerLinkClickedUpdateContentEvent=function(e,t){attachHandler(e,"click",function(){updatePrimaryProduct(t)})};var trackProductView=function(e,t){var n=JSON.stringify({productId:e,postId:t});parent.postMessage(n,"*")};$(document).ready(function(){imageUrl=getUrlParameters("imageurl","",true);bloggerId=getUrlParameters("bloggerid","",true);blogId=getUrlParameters("blogid","",true);postId=getUrlParameters("postid","",true);$("body").on("click","a#buybtn",function(){buyTrack(bloggerId,blogId,imageUrl,postId)});getProducts(imageUrl,function(e){console.log(e);updatePrimaryProduct(e[0]);generateSlider(e);$("#productSlider").mCustomScrollbar({theme:"minimal",axis:"x",advanced:{autoExpandHorizontalScroll:true}})})})